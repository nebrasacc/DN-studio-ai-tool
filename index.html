<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DN AI Studio | Genesis Frameworks</title>
  <!-- Tailwind (CDN JIT) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel for in-browser JSX transpile -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Lucide icons (vanilla, we wrap as React component) -->
  <script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.js"></script>
  <style>
    html, body { background: #000; }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState, useCallback } = React;

    // ---- Lucide React-less bridge ----
    const LucideIcon = ({ name, size = 16, className = '' }) => {
      const ref = useRef(null);
      useEffect(() => {
        try {
          // Re-scan the document to upgrade any <i data-lucide> into inline SVG
          window.lucide && window.lucide.createIcons({ attrs: { width: size, height: size } });
        } catch {}
      }, [name, size]);
      return <i ref={ref} data-lucide={name} className={className}></i>;
    };
    const makeIcon = (n) => (props) => <LucideIcon name={n} {...props} />;
    const Clock = makeIcon('clock');
    const Download = makeIcon('download');
    const FileText = makeIcon('file-text');
    const ImageIcon = makeIcon('image');
    const DollarSign = makeIcon('dollar-sign');
    const Settings = makeIcon('settings');
    const Sparkles = makeIcon('sparkles');
    const X = makeIcon('x');
    const Wand2 = makeIcon('wand-2');
    const Film = makeIcon('film');
    const CheckSquare = makeIcon('check-square');
    const BrainCircuit = makeIcon('brain-circuit');
    const Music = makeIcon('music');
    const Type = makeIcon('type');
    const RotateCw = makeIcon('rotate-cw');
    const Loader2 = makeIcon('loader-2');
    const Key = makeIcon('key');
    const List = makeIcon('list');
    const Zap = makeIcon('zap');
    const Eye = makeIcon('eye');

    // --- Global Constants and Helper Functions ---
    const cn = (...a) => a.filter(Boolean).join(' ');

    // 1. Audio Engine
    const AudioEngine = {
      ctx: null,
      init() {
        if (this.ctx) return;
        try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch {}
      },
      play(type) {
        if (!this.ctx) return;
        const o = this.ctx.createOscillator(), g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        g.gain.setValueAtTime(0, this.ctx.currentTime);
        if (type === 'click') {
          o.type='sine'; o.frequency.setValueAtTime(600,this.ctx.currentTime); g.gain.linearRampToValueAtTime(0.15,this.ctx.currentTime+0.01);
          o.frequency.exponentialRampToValueAtTime(300,this.ctx.currentTime+0.1); g.gain.exponentialRampToValueAtTime(1e-4,this.ctx.currentTime +0.1);
        } else if (type === 'success') {
          o.type='sine'; o.frequency.setValueAtTime(523.25, this.ctx.currentTime); g.gain.linearRampToValueAtTime(0.2,this.ctx.currentTime+0.01);
          o.frequency.exponentialRampToValueAtTime(1046.5,this.ctx.currentTime+0.15); g.gain.exponentialRampToValueAtTime (1e-4,this.ctx.currentTime +0.15);
        } else if (type === 'error') {
          o.type='square'; o.frequency.setValueAtTime(200,this.ctx.currentTime); g.gain.linearRampToValueAtTime(0.2,this.ctx.currentTime+0.01);
          o.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime +0.2); g.gain.exponentialRampToValueAtTime(1e-4,this.ctx.currentTime +0.2);
        }
        o.start(this.ctx.currentTime); o.stop(this.ctx.currentTime + 0.22);
      }
    };

    // 2. IndexedDB Helpers
    const idb = (() => {
      let dbPromise = null;
      function getDB() {
        if (!('indexedDB' in window)) return null;
        if (!dbPromise) {
          dbPromise = new Promise((resolve, reject) => {
            const req = indexedDB.open('dn-ai-pro-apex-db-v2', 2);
            req.onupgradeneeded = (e) => {
              const db = e.target.result;
              if (!db.objectStoreNames.contains('images')) db.createObjectStore('images');
              if (!db.objectStoreNames.contains('history')) db.createObjectStore('history', { keyPath: 'timestamp' });
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
          });
        }
        return dbPromise;
      }
      return {
        async getHistory() {
          const db = await getDB();
          if (!db) return [];
          return new Promise((res, rej) => {
            const r = db.transaction('history', 'readonly').objectStore('history').getAll();
            r.onsuccess = () => res(r.result.sort((a,b) => b.timestamp - a.timestamp));
            r.onerror = () => rej(r.error);
          });
        },
        async addHistory(item) {
          const db = await getDB();
          if (!db) return false;
          return new Promise((res, rej) => {
            const t = db.transaction('history', 'readwrite');
            t.objectStore('history').put(item);
            t.oncomplete = () => res(true);
            t.onerror = () => rej(t.error);
          });
        }
      };
    })();

    // 3. Task Queue
    class TaskQueue {
      running = 0;
      q = [];
      max;
      onComplete = () => {};
      constructor(max = 3) { this.max = max; }
      setMax(n) { this.max = Math.max(1, n); this.tick(); }
      push(task) { this.q.push(task); this.tick(); }
      clear() { this.q.length = 0; this.onComplete(); }
      async tick() {
        if (this.running === 0 && this.q.length === 0) { this.onComplete(); return; }
        while (this.running < this.max && this.q.length > 0) {
          const t = this.q.shift();
          this.running++;
          t().finally(() => { this.running--; this.tick(); });
        }
      }
    }

    // 4. API Client with Exponential Backoff
    async function safeFetchWithRetry(url, options, maxRetries) {
      const apiKey = ""; // provide your key if needed
      const fullUrl = `${url}?key=${apiKey}`;
      for (let attempt = 0; attempt <= maxRetries; attempt++) {
        try {
          if (attempt > 0) {
            const delay = 1500 * Math.pow(2, attempt - 1);
            await new Promise(r => setTimeout(r, delay));
          }
          const response = await fetch(fullUrl, options);
          const json = await response.json();
          if (!response.ok) {
            const errorMessage = json.error?.message || json.error || `API error (${response.status}): ${JSON.stringify(json)}`;
            throw new Error(errorMessage);
          }
          return json;
        } catch (e) {
          if (attempt === maxRetries) throw e;
        }
      }
    }

    async function callText(parts, system, jsonSchema, retryCount) {
      const model = 'gemini-2.5-flash-preview-05-20';
      const body = {
        contents: [{ parts }],
        systemInstruction: system ? { parts: [{ text: system }] } : undefined,
        generationConfig: jsonSchema ? { responseMimeType: 'application/json', responseSchema: jsonSchema } : undefined
      };
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
      const json = await safeFetchWithRetry(url, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      }, retryCount);
      const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!text) throw new Error('Text API returned no content.');
      return text;
    }

    async function callImage(promptText, ref, retryCount) {
      const model = 'gemini-2.5-flash-image-preview';
      const parts = [{ text: promptText }];
      if (ref) {
        const b64 = ref.split(',')[1];
        parts.push({ inlineData: { mimeType: 'image/jpeg', data: b64 } });
      }
      const body = { contents: [{ parts }], generationConfig: { responseModalities: ['IMAGE'] } };
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;
      const json = await safeFetchWithRetry(url, {
        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      }, retryCount);
      const base64 = json.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
      if (!base64) throw new Error('Image API returned no image data.');
      return `data:image/png;base64,${base64}`;
    }

    const fileToBase64 = (file) => new Promise((res, rej) => {
      const r = new FileReader(); r.onload = () => res(String(r.result)); r.onerror = rej; r.readAsDataURL(file);
    });

    function App() {
      const textModel = 'gemini-2.5-flash-preview-05-20';
      const [visualStyle, setVisualStyle] = useState('Cinematic Photorealistic');
      const [aspectRatio, setAspectRatio] = useState('16:9');
      const [narrative, setNarrative] = useState('A lone astronaut, EVA ROSTOVA, discovers a glowing alien artifact on Mars. It pulses with light, drawing her closer. She touches it, and the Martian landscape warps into a lush, alien jungle.');
      const [refImg, setRefImg] = useState(null);
      const [charLock, setCharLock] = useState(true);
      const [predicted, setPredicted] = useState(null);
      const [scenes, setScenes] = useState([]);
      const [busy, setBusy] = useState(false);
      const [status, setStatus] = useState('System Initialized. Ready for Quantum Processing.');
      const [err, setErr] = useState(null);
      const [showSettings, setShowSettings] = useState(false);
      const [showHistoryModal, setShowHistoryModal] = useState(false);
      const [historyItems, setHistoryItems] = useState([]);
      const [editingScene, setEditingScene] = useState(null);
      const [editPrompt, setEditPrompt] = useState('');
      const [isEditing, setIsEditing] = useState(false);
      const [creditsUsed, setCreditsUsed] = useState(0.00);
      const [characterSheet, setCharacterSheet] = useState(null);
      const [directorsVision, setDirectorsVision] = useState(null);
      const [magicToolOutput, setMagicToolOutput] = useState(null);
      const [showVisionModal, setShowVisionModal] = useState(false);
      const [scriptFile, setScriptFile] = useState(null);
      const [apiKey, setApiKey] = useState('');

      const maxConcurrent = 4;
      const retryCount = 2;
      const queueRef = useRef(new TaskQueue(maxConcurrent));

      useEffect(() => { AudioEngine.init(); idb.getHistory().then(setHistoryItems).catch(() => console.error('Failed to load history.')); }, []);

      const aspectRatioClass = useMemo(() => ({ '16:9': 'aspect-[16/9]', '9:16': 'aspect-[9/16]', '1:1': 'aspect-square', '4:3': 'aspect-[4/3]' }[aspectRatio] || 'aspect-[16/9]'), [aspectRatio]);
      const incrementCredits = useCallback(() => setCreditsUsed(c => parseFloat((c + 0.10).toFixed(2))), []);

      const loadHistoryItem = useCallback((item) => {
        setNarrative(item.vision?.refined_script || 'Script reloaded from history.');
        setDirectorsVision(item.vision); setScenes(item.scenes); setPredicted(null); setCreditsUsed(item.cost);
        setVisualStyle(item.config.visualStyle); setAspectRatio(item.config.aspectRatio); setScriptFile(item.config.scriptFile || null);
        setCharacterSheet(item.vision?.character_sheet || null); setShowHistoryModal(false); setStatus('Project state reloaded successfully.'); AudioEngine.play('success');
      }, []);

      async function extractScriptFromDocument(file) {
        setStatus(`Analyzing ${file.name} (Initiating deep-scan sequence, $0.05 charge)...`);
        const mimeType = file.type; const base64Data = (await fileToBase64(file)).split(',')[1];
        const sys = 'You are an expert film industry document processor. Analyze the provided document (PDF, DOCX, or TXT) and extract the screenplay, teleplay, or narrative text. It is CRITICAL that you preserve all original formatting, including SCENE HEADERS (EXT./INT.), CHARACTER NAMES, DIALOGUE blocks, and ACTION lines. Your output MUST be the raw, formatted script text only. Do NOT add any introductory or explanatory text. Ignore all document metadata, page numbers, and margin notes.';
        const parts = [{ text: 'Extract the full formatted script from this document.' }, { inlineData: { mimeType, data: base64Data } }];
        try { const extractedText = await callText(parts, sys, undefined, retryCount); return extractedText; }
        catch (e) { console.error('Gemini Document Extraction Failed:', e); throw new Error(`Failed to extract script from document. Check file formatting or try plain text. Error: ${String(e.message)}`); }
      }

      async function handleScriptUpload(e) {
        const file = e.target.files?.[0]; if (!file) return;
        setScriptFile(file.name); setBusy(true); setErr(null);
        try {
          let extractedContent = '';
          if (file.type.startsWith('text/')) {
            extractedContent = await file.text();
          } else if (['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'].includes(file.type)) {
            extractedContent = await extractScriptFromDocument(file); setCreditsUsed(c => parseFloat((c + 0.05).toFixed(2)));
          } else { throw new Error(`Unsupported file type: ${file.type}`); }
          setNarrative(extractedContent); setStatus(`Script data stream initialized from ${file.name}.`); AudioEngine.play('success');
        } catch (error) { setErr(String(error.message)); setStatus('Error: Failed to process data stream.'); AudioEngine.play('error'); }
        finally { setBusy(false); }
      }

      async function runAiDirector() {
        AudioEngine.play('click'); setBusy(true); setErr(null); setStatus('AI Director is analyzing your script...'); setDirectorsVision(null); setCharacterSheet(null); setPredicted(null); setScenes([]);
        try {
          let charSheet = null;
          if (refImg && charLock) {
            setStatus('Analyzing character reference image using multi-modal sensor...');
            const sysChar = 'You are a forensic artist. Describe the person in this image in extreme detail for a character sheet. Focus on facial features, hair, ethnicity, build, and unique identifiers. Respond in JSON with a single key \'description\'.';
            const schemaChar = { type: 'OBJECT', properties: { description: { type: 'STRING' } }, required: ['description'] };
            const partsChar = [{ text: 'Describe this person.' }, { inlineData: { mimeType: 'image/jpeg', data: refImg.split(',')[1] } }];
            const charResult = await callText(partsChar, sysChar, schemaChar, retryCount);
            charSheet = JSON.parse(charResult).description; setCharacterSheet(charSheet);
          }
          setStatus("Developing Director's Vision Matrix...");
          const sysVision = `You are an acclaimed film director. Analyze this script and the provided character/brand info. Generate a "Director's Vision" document as JSON.`;
          const schemaVision = { type: 'OBJECT', properties: { main_character: { type: 'STRING' }, core_theme: { type: 'STRING' }, visual_tone: { type: 'STRING' }, cinematography_style: { type: 'STRING' }, refined_script: { type: 'STRING' } }, required: ['main_character','core_theme','visual_tone','cinematography_style','refined_script'] };
          const visionResult = await callText([{ text: narrative }], sysVision, schemaVision, retryCount);
          const vision = JSON.parse(visionResult); if (charSheet) vision.character_sheet = charSheet;
          setDirectorsVision(vision); setShowVisionModal(true); setStatus("Director's Vision complete. Awaiting user approval to proceed with scene segmentation."); AudioEngine.play('success');
        } catch (e) { setErr(String(e.message || e)); setStatus('AI Director analysis failed. Review script input.'); AudioEngine.play('error'); }
        finally { setBusy(false); }
      }

      async function generateScenesFromVision() {
        AudioEngine.play('click'); setShowVisionModal(false); setBusy(true); setErr(null); setStatus('Generating scene prompts based on Vision and Style Matrix...');
        try {
          if (!directorsVision) throw new Error("Director's Vision Matrix is missing.");
          const visionContext = `DIRECTOR'S VISION: Theme: ${directorsVision.core_theme}, Tone: ${directorsVision.visual_tone}, Cinematography: ${directorsVision.cinematography_style}${directorsVision.character_sheet ? ` Main Character (${directorsVision.main_character}) Appearance: ${directorsVision.character_sheet}` : ''}`;
          const schema = { type: 'ARRAY', items: { type: 'OBJECT', properties: { sceneHeader: { type: 'STRING' }, prompt: { type: 'STRING' } }, required: ['sceneHeader','prompt'] } };
          const sys = `You are a storyboard artist. Use the refined script and strictly adhere to the DIRECTOR'S VISION to create production-grade image prompts. The vision is paramount. If the main character is mentioned, their appearance MUST match the character sheet. URGENT AND MANDATORY: All images must be rendered in a "${visualStyle}" style and have an exact aspect ratio of "${aspectRatio}". Respond in JSON only.`;
          const text = await callText([{ text: `Refined Script: \n\n${directorsVision.refined_script}\n\n${visionContext}` }], sys, schema, retryCount);
          const parsed = JSON.parse(text); setPredicted(parsed.map((s,i) => ({ id: i, ...s }))); setStatus(`Generated ${parsed.length} visual segment prompts. Ready to synthesize frames.`); AudioEngine.play('success');
        } catch (e) { setErr(String(e.message || e)); setStatus('Error generating visual segment prompts.'); AudioEngine.play('error'); }
        finally { setBusy(false); }
      }

      const runGenerationTask = useCallback(async (sceneData, isRetry = false) => {
        const update = (patch) => setScenes(prev => prev.map(s => s.id === sceneData.id ? { ...s, ...patch } : s));
        let attempt = 0, ok = false, imageUrl = null, errorMsg = '';
        const finalPrompt = `URGENT, MANDATORY: Render in a "${visualStyle}" style. The final image MUST have an exact aspect ratio of "${aspectRatio}". SCENE PROMPT: ${sceneData.prompt}`;
        try {
          update({ status: 'starting' });
          while (attempt <= retryCount && !ok) {
            attempt++; if (isRetry || attempt > 1) incrementCredits();
            update({ status: attempt > 1 ? `retrying ${attempt - 1}/${retryCount}` : 'generating' });
            try { const img = await callImage(finalPrompt, (charLock && refImg) ? refImg : null, 0); imageUrl = img; ok = true; }
            catch (err) { errorMsg = String(err.message || err); if (attempt <= retryCount) await new Promise(r => setTimeout(r, 1500)); }
          }
          update({ status: ok ? 'success' : 'error', image: imageUrl, error: ok ? null : errorMsg }); AudioEngine.play(ok ? 'success' : 'error');
        } catch (err) { update({ status: 'error', error: String(err.message || err) }); AudioEngine.play('error'); }
      }, [aspectRatio, charLock, incrementCredits, refImg, retryCount, visualStyle]);

      useEffect(() => {
        queueRef.current.onComplete = () => {
          setTimeout(() => {
            setBusy(false); setStatus('Frame Synthesis complete. All tasks terminated.');
            setScenes(current => {
              if (current.length > 0 && current.every(s => ['success','error'].includes(s.status))) {
                const historyEntry = { timestamp: Date.now(), scenes: current.map(s => ({...s, status: s.status, prompt: s.prompt})), cost: creditsUsed, vision: directorsVision, config: { visualStyle, aspectRatio, scriptFile } };
                idb.addHistory(historyEntry).then(() => idb.getHistory().then(setHistoryItems)).catch(() => console.error('Failed to save history'));
                return current;
              }
              return current;
            });
          }, 400);
        };
      }, [creditsUsed, directorsVision, visualStyle, aspectRatio, scriptFile]);

      function generateAllImages() {
        if (!predicted?.length) return; AudioEngine.play('click');
        if (predicted.length > 0) setCreditsUsed(c => parseFloat((c + predicted.length * 0.10).toFixed(2)));
        setScenes(predicted.map(s => ({ ...s, status: 'queued', image: null, error: null }))); setBusy(true); setErr(null); setStatus('Starting parallel quantum image synthesis...');
        predicted.forEach(s => queueRef.current.push(() => runGenerationTask(s)));
      }

      function regenerateScene(sceneId) {
        AudioEngine.play('click'); const s = scenes.find(x => x.id === sceneId); if (s) {
          setBusy(true); setStatus('Retrying scene generation...');
          setScenes(prev => prev.map(scene => scene.id === sceneId ? { ...scene, status: 'queued', error: null } : scene));
          queueRef.current.push(() => runGenerationTask(s, true));
        }
      }

      async function handleEditImage() {
        AudioEngine.play('click'); if (!editingScene || !editPrompt) return; setIsEditing(true); setErr(null); incrementCredits();
        try {
          const fullEditPrompt = `Based on the attached image, apply this change: ${editPrompt}. Maintain the style and aspect ratio.`;
          const newImageUrl = await callImage(fullEditPrompt, editingScene.image, retryCount);
          setScenes(prev => prev.map(s => s.id === editingScene.id ? { ...s, image: newImageUrl, prompt: `${s.prompt}\n\n[USER EDIT: ${editPrompt}]` } : s));
          setEditingScene(null); setEditPrompt(''); setStatus('Image edited successfully. New frame synthesized.'); AudioEngine.play('success');
        } catch (e) { setErr(`Failed to edit image: ${String(e.message || e)}`); AudioEngine.play('error'); }
        finally { setIsEditing(false); }
      }

      async function runMagicTool(tool) {
        AudioEngine.play('click'); setBusy(true); setMagicToolOutput({ tool, loading: true, title: tool.replace(/_/g, ' ') }); setErr(null);
        try {
          if (!narrative) throw new Error('A script is required.');
          let sys = '', schema = null, isJson = true;
          const context = directorsVision ? `Use this Director's Vision as context: ${JSON.stringify(directorsVision)}` : '';
          if (tool === 'titles') {
            sys = `You are a world-class marketing copywriter. Based on the script and director's vision, generate 7 punchy, high-concept, marketable movie titles. JSON array of strings. ${context}. Focus on cinematic impact and memorability.`;
            schema = { type: 'ARRAY', items: { type: 'STRING' } };
          } else if (tool === 'logline') {
            sys = `You are a professional screenwriter. Based on the script and director's vision, write a single, perfect logline (25 words max). Plain text. ${context}. Make it incredibly hooky and high-concept, focusing on protagonist, goal, and stakes.`;
            isJson = false;
          } else if (tool === 'doctor') {
            sys = `You are a script doctor specializing in visual storytelling and pacing. Provide 5 actionable, structural improvements to the script focusing on escalating tension, visual clarity of action, and scene flow, keeping the director's vision in mind. JSON array of strings. ${context}`;
            schema = { type: 'ARRAY', items: { type: 'STRING' } };
          } else if (tool === 'music') {
            sys = `You are a film score composer. Based on the script and director's vision, suggest a music genre, mood, and 3-5 key sound effects and their emotional purpose. JSON object. ${context}`;
            schema = { type: 'OBJECT', properties: { genre: { type: 'STRING' }, mood: { type: 'STRING' }, sound_effects: { type: 'ARRAY', items: { type: 'STRING' } } }, required: ['genre','mood','sound_effects'] };
          } else if (tool === 'breakdown') {
            sys = `You are a professional cinematographer/storyboard supervisor. Analyze the provided script and generate a shot-by-shot visual breakdown focusing on the first 3-5 key moments/sentences. For each moment, suggest a primary shot type (e.g., Extreme Wide Shot, Close-Up, POV, Tracking Shot) and the desired emotional impact. Respond in JSON with an array of objects, each having 'moment' (string), 'shot' (string), and 'emotion' (string). ${context}`;
            schema = { type: 'ARRAY', items: { type: 'OBJECT', properties: { moment: { type: 'STRING' }, shot: { type: 'STRING' }, emotion: { type: 'STRING' } }, required: ['moment','shot','emotion'] } };
          }
          const rawResult = await callText([{ text: narrative }], sys, isJson ? schema : undefined, retryCount);
          const result = isJson ? JSON.parse(rawResult) : rawResult;
          setMagicToolOutput({ tool, loading: false, data: result, title: tool.replace(/_/g, ' ') }); setStatus(`Magic Tool (${tool}) output generated.`); AudioEngine.play('success');
        } catch (e) { setErr(`Magic tool failed: ${String(e.message || e)}`); setStatus(`Magic Tool (${tool}) failed.`); AudioEngine.play('error'); }
        finally { setBusy(false); }
      }

      const MagicToolButton = ({ tool, icon: Icon, children }) => (
        <button onClick={() => runMagicTool(tool)} disabled={!narrative || busy} className="premium-button w-full flex items-center justify-center gap-2 px-2 py-2 text-sm font-semibold rounded-md bg-slate-800/70 border border-cyan-500/20 hover:bg-cyan-900/50 disabled:opacity-50 disabled:cursor-not-allowed">
          <Icon size={14} className="text-cyan-400" /> {children}
        </button>
      );

      const AnimatedWait = () => {
        const [tagline, setTagline] = useState('Conjuring Pixels...');
        const taglines = ['Directing Photons...', 'Weaving Narratives...', 'Synthesizing Vision...', 'Orchestrating Creativity...', 'Painting with Light...', 'Executing Quantum Tasks...', 'Loading Neural Network...'];
        const completedCount = scenes.filter(s => ['success', 'error'].includes(s.status)).length;
        const totalScenes = scenes.length; const progress = totalScenes > 0 ? Math.round((completedCount / totalScenes) * 100) : 0;
        useEffect(() => { if (!busy) return; const i = setInterval(() => setTagline(taglines[Math.floor(Math.random() * taglines.length)]), 1800); return () => clearInterval(i); }, [busy]);
        if (!busy) return null;
        return (
          <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex flex-col items-center justify-center font-sans">
            <div className="loader-orb" />
            <div className="mt-4 text-white text-3xl font-extrabold tracking-widest">{progress}%</div>
            <div className="w-64 h-2 bg-slate-800 rounded-full overflow-hidden mt-2">
              <div className="h-full bg-cyan-400 transition-all duration-300 ease-in-out" style={{ width: `${progress}%` }}></div>
            </div>
            <p className="mt-4 text-cyan-300 font-semibold text-lg tracking-wider animate-[floaty_3s_ease-in-out_infinite]">{tagline} <span className="text-sm text-slate-400">({completedCount}/{totalScenes} done)</span></p>
          </div>
        );
      };

      return (
        <div className="min-h-screen animated-bg text-gray-200 font-sans">
          <style jsx="true">{`
            @keyframes gradientFlow { 0% {background-position:0% 50%} 50% {background-position: 100% 50%} 100%{background-position: 0% 50%} }
            @keyframes floaty { 0% {transform: translateY(0)} 50% {transform: translateY(-6px)} 100%{transform: translateY(0)} }
            @keyframes starfield { 0% {transform: translateY(0)} 100% {transform: translateY(-2000px)} }
            .animated-bg { background: linear-gradient(-45deg, #00010a, #0a011a, #010a0a, #00010a); background-size: 400% 400%; animation: gradientFlow 25s ease infinite; position: relative; overflow: hidden; }
            .animated-bg::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: transparent; background-image: radial-gradient(white, rgba(255, 255, 255, 0) 1px), radial-gradient(rgba(255, 255, 255, 0.2) 1px, transparent 1px); background-size: 100px 100px, 300px 300px; opacity: 0.1; animation: starfield 200s linear infinite; pointer-events: none; }
            .glass-pane { background: rgba(10,15,30,.3); backdrop-filter: blur(16px) brightness(1.1); border: 1px solid rgba(0,255,255,.15); box-shadow: 0 4px 30px rgba(0,0,0,.3); }
            .premium-button { transition: all .3s cubic-bezier(.17,.67,.83,.67); transform-style: preserve-3d; }
            .premium-button:hover:not(:disabled) { transform: translateY(-3px) scale(1.01); box-shadow: 0 12px 25px rgba(0,255,255,.2); border-color: rgba(0,255,255,.5); }
            .loader-orb { width: 110px; height: 110px; border-radius: 50%; filter: drop-shadow(0 0 20px rgba(0,255,255,.4)); background: conic-gradient(from 0deg, #06b6d4 0 120deg, transparent 120deg 240deg, #60a5fa 240deg 360deg); animation: spin 1.2s linear infinite; position: relative }
            .loader-orb::after { content:""; position:absolute; inset: 12px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.3), #000 70%); }
            @keyframes spin { to { transform: rotate(360deg)} }
          `}</style>

          <AnimatedWait />

          <header className="sticky top-0 z-40 border-b border-cyan-400/20 backdrop-blur-xl bg-black/50">
            <div className="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center gap-4">
              <Zap size={30} className="text-cyan-400 animate-pulse" />
              <div className="flex-1">
                <h1 className="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500 tracking-wider">
                  DN AI Studio <span className="text-lg text-slate-400 font-medium">| GENESIS FRAMEWORKS</span>
                </h1>
                <p className="text-xs text-cyan-500/60 font-mono">Model: {textModel} | Status: Online</p>
              </div>
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2 text-green-400/90 bg-green-900/30 px-3 py-1 rounded-full text-sm font-semibold border border-green-500/30">
                  <DollarSign size={16} />{creditsUsed.toFixed(2)} CREDITS
                </div>
                <button onClick={() => { AudioEngine.play('click'); setShowHistoryModal(true); }} className="premium-button flex items-center gap-2 text-xs px-3 py-1.5 rounded-md bg-slate-800/80 hover:bg-cyan-900/40 border border-cyan-500/20">
                  <Clock size={14} /> HISTORY LOG
                </button>
                <button onClick={() => { AudioEngine.play('click'); setShowSettings(true); }} className="premium-button flex items-center gap-2 text-xs px-3 py-1.5 rounded-md bg-slate-800/80 hover:bg-cyan-900/40 border border-cyan-500/20">
                  <Settings size={14} /> CONSOLE
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-screen-2xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 px-4 sm:px-6 lg:px-8 py-6">
            <section className="lg:col-span-3 space-y-4">
              <div className="glass-pane rounded-xl p-4">
                <h2 className="font-semibold mb-3 text-cyan-400 flex items-center gap-2"><Eye size={16} /> Visual Matrix</h2>
                <div className="grid grid-cols-2 gap-3">
                  <select value={visualStyle} onChange={e => setVisualStyle(e.target.value)} className="w-full bg-slate-800/70 border border-slate-700 rounded-md px-2 py-2 text-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150">
                    <option>Cinematic Photorealistic</option><option>Noir Comic Book</option><option>Modern Anime</option>
                    <option>Vintage Cartoon</option><option>Hollywood Glamour</option><option>3D Render</option>
                    <option>Cyberpunk Neon</option><option>Fantasy Art</option>
                  </select>
                  <select value={aspectRatio} onChange={e => setAspectRatio(e.target.value)} className="w-full bg-slate-800/70 border border-slate-700 rounded-md px-2 py-2 text-sm focus:ring-cyan-500 focus:border-cyan-500 transition duration-150">
                    <option value="16:9">16:9 (Widescreen)</option><option value="9:16">9:16 (Vertical)</option>
                    <option value="1:1">1:1 (Square)</option><option value="4:3">4:3 (Classic)</option>
                  </select>
                </div>
              </div>

              <div className="glass-pane rounded-xl p-4">
                <h2 className="font-semibold mb-3 text-cyan-400 flex items-center gap-2"><ImageIcon size={16} /> Asset Synchronization</h2>
                <div>
                  <label className="block text-xs text-gray-400 mb-1">Reference Character Image (for locking)</label>
                  <input type="file" accept="image/*" onChange={async e => { if (e.target.files?.[0]) setRefImg(await fileToBase64(e.target.files[0])); }} className="w-full text-xs file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:bg-slate-700 hover:file:bg-slate-600 file:text-slate-200 cursor-pointer"/>
                  <div className="mt-2 flex items-center gap-2 text-sm">
                    <input id="charLock" type="checkbox" checked={charLock} onChange={e => setCharLock(e.target.checked)} className="h-4 w-4 rounded bg-slate-700 text-cyan-500 border-none focus:ring-0 cursor-pointer" />
                    <label htmlFor="charLock" className="text-sm">Enable Character Lock (Synchronize visual identity)</label>
                  </div>
                </div>
              </div>

              <div className="glass-pane rounded-xl p-4">
                <h2 className="font-semibold mb-2 text-cyan-400 flex items-center gap-2"><FileText size={16} /> Script Data Stream</h2>
                <label className="block text-xs text-gray-400 mb-1">Upload PDF, DOCX, or TXT (AI Deep-Scan $0.05)</label>
                <input type="file" accept=".pdf, .docx, .txt, application/pdf, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/plain" onChange={handleScriptUpload} className="w-full text-xs file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:bg-cyan-700 hover:file:bg-cyan-600 file:text-white cursor-pointer"/>
                {scriptFile && <p className="text-xs text-slate-500 mt-1 truncate">Loaded Source: {scriptFile}</p>}
                <label className="block text-xs text-gray-400 mt-3 mb-1">Narrative Text Input</label>
                <textarea value={narrative} onChange={e => setNarrative(e.target.value)} rows={8} className="w-full bg-slate-800/70 border border-slate-700 rounded-md p-2 text-sm font-mono focus:ring-cyan-500 focus:border-cyan-500"></textarea>
              </div>

              <div className="glass-pane rounded-xl p-4">
                <h2 className="font-semibold mb-3 text-cyan-400 flex items-center gap-2"><BrainCircuit size={16} /> AI Director Module</h2>
                <button onClick={runAiDirector} disabled={!narrative || busy} className="premium-button w-full px-2 py-2 text-sm font-bold rounded-md bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg hover:from-blue-500 hover:to-cyan-500 disabled:bg-slate-700 disabled:cursor-not-allowed">
                  <span className="flex items-center gap-2"><BrainCircuit size={16} /> INITIATE DIRECTOR'S VISION</span>
                </button>
              </div>

              <div className="glass-pane rounded-xl p-4">
                <h2 className="font-semibold mb-3 text-cyan-400 flex items-center gap-2"><Sparkles size={16} /> Creative Synthesis Tools</h2>
                <div className="grid grid-cols-2 gap-2">
                  <MagicToolButton tool="titles" icon={Type}>Title Generation</MagicToolButton>
                  <MagicToolButton tool="logline" icon={Film}>Logline Synthesis</MagicToolButton>
                  <MagicToolButton tool="doctor" icon={CheckSquare}>Script Optimization</MagicToolButton>
                  <MagicToolButton tool="music" icon={Music}>Soundscape Suggestion</MagicToolButton>
                  <MagicToolButton tool="breakdown" icon={List}>Shot Breakdown</MagicToolButton>
                </div>
              </div>

              {err && (
                <div className="bg-red-900/40 border border-red-500/50 p-3 rounded-xl text-red-300 text-sm">
                  <p className="font-semibold">SYSTEM ERROR:</p>
                  <p className="mt-1">{err}</p>
                </div>
              )}
            </section>

            <section className="lg:col-span-9 space-y-4">
              <div className="glass-pane rounded-xl p-3 text-center text-sm font-mono tracking-wider border-cyan-400/30">
                SYSTEM LOG: <span className={cn(busy ? 'text-yellow-400' : 'text-cyan-400', 'font-semibold')}>{status}</span>
              </div>

              {scenes.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                  {scenes.map(s => (
                    <div key={s.timestamp || s.id} className="glass-pane rounded-xl overflow-hidden flex flex-col shadow-2xl">
                      <div className="px-3 py-2 border-b border-cyan-500/20 flex items-center justify-between bg-slate-800/50">
                        <div className="text-sm font-semibold truncate pr-2 text-slate-200">{s.sceneHeader}</div>
                        <span className={cn('text-xs px-2 py-0.5 rounded-full font-medium', s.status === 'success' && 'bg-green-500/20 text-green-300 border border-green-500/50', s.status === 'error' && 'bg-red-500/20 text-red-300 border border-red-500/50', s.status === 'queued' && 'bg-slate-500/20 text-slate-300 border border-slate-500/50', (s.status === 'generating' || s.status === 'starting' || String(s.status).startsWith('retrying')) && 'bg-blue-500/20 text-blue-300 animate-pulse border border-blue-500/50')}>{String(s.status).includes('retrying') ? 'RETRY' : s.status.toUpperCase()}</span>
                      </div>
                      <div className={cn('relative bg-black/50 transition-all duration-300', aspectRatioClass)}>
                        {['generating', 'starting'].includes(s.status) || String(s.status).startsWith('retrying') ? (
                          <div className="absolute inset-0 flex items-center justify-center"><div className="loader-orb w-16 h-16" /></div>
                        ) : s.image ? (
                          <img src={s.image} alt={s.sceneHeader} className="w-full h-full object-cover transition-opacity duration-500" />
                        ) : (
                          <div className="absolute inset-0 flex items-center justify-center text-slate-500 text-xs p-2 text-center bg-slate-900/80">{s.status === 'error' ? (s.error || 'Error: Frame Data Corrupted') : 'Queued... Awaiting Execution.'}</div>
                        )}
                      </div>
                      <div className="p-3 border-t border-cyan-500/10">
                        <textarea value={s.prompt} readOnly className="w-full bg-slate-800/70 border-0 rounded-md p-2 text-xs h-24 cursor-default resize-none text-slate-400"></textarea>
                      </div>
                      <div className="px-3 py-2 border-t border-cyan-500/10 flex items-center justify-end gap-2 bg-slate-800/50">
                        {s.image && <button onClick={() => { AudioEngine.play('click'); setEditingScene(s); }} className="premium-button p-2 rounded-md bg-slate-700/50 hover:bg-slate-600/70 border border-slate-600" title="Edit Image"><Wand2 size={14} className='text-yellow-400' /></button>}
                        <button onClick={() => regenerateScene(s.id)} disabled={busy} className="premium-button p-2 rounded-md bg-slate-700/50 hover:bg-slate-600/70 border border-slate-600 disabled:opacity-50" title="Retry"><RotateCw size={14} className='text-orange-400'/></button>
                        {s.image && <button onClick={() => { AudioEngine.play('click'); const a = document.createElement('a'); a.href = s.image; a.download = `DN_AI_Frame_${s.id}.png`; a.click(); }} className="premium-button p-2 rounded-md bg-cyan-600 hover:bg-cyan-500" title="Download"><Download size={14} /></button>}
                      </div>
                    </div>
                  ))}
                </div>
              ) : predicted ? (
                <div className="glass-pane rounded-xl p-6">
                  <h2 className="font-extrabold text-xl text-cyan-300 border-b border-cyan-500/30 pb-2 mb-4">SEGMENTATION PROTOCOL</h2>
                  <p className="text-sm text-slate-400 mb-4">The Director Module has segmented the narrative into {predicted.length} visual prompts. Confirm parameters before Frame Synthesis.</p>
                  <ol className="divide-y divide-slate-800 space-y-3">
                    {predicted.map(s => (
                      <li key={s.id} className="py-3">
                        <div className="text-sm font-semibold text-slate-300 flex items-center gap-2"><Film size={14} className='text-blue-400'/> {s.sceneHeader}</div>
                        <p className="mt-1 w-full bg-slate-800/50 border border-slate-700 rounded-md p-2 text-xs text-slate-400 font-mono">{s.prompt}</p>
                      </li>
                    ))}
                  </ol>
                  <div className="mt-6">
                    <button onClick={generateAllImages} disabled={busy} className="premium-button w-full px-3 py-3 text-lg font-bold rounded-md bg-gradient-to-r from-green-500 to-teal-600 text-white shadow-xl hover:from-green-400 hover:to-teal-500 disabled:bg-slate-700 disabled:opacity-50">
                      EXECUTE FRAME SYNTHESIS (${(predicted?.length || 0 * 0.10).toFixed(2)})
                    </button>
                  </div>
                </div>
              ) : (
                <div className="glass-pane rounded-xl p-8 text-center flex flex-col items-center justify-center min-h-[50vh]">
                  <Wand2 size={64} className="text-cyan-400/50 animate-pulse" />
                  <div className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500 mt-4 tracking-widest">DN AI STUDIO</div>
                  <p className="text-gray-400 mt-2 max-w-md">The future of visual development is here. Upload your script and initiate the AI Director module to begin generating high-fidelity storyboards.</p>
                  <button onClick={() => document.querySelector('textarea')?.focus()} className="premium-button mt-6 px-6 py-3 text-base font-semibold bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 rounded-lg shadow-xl">Start New Project</button>
                </div>
              )}
            </section>
          </main>

          {showVisionModal && directorsVision && (
            <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-lg flex items-center justify-center p-4" onClick={() => setShowVisionModal(false)}>
              <div className="glass-pane rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border-yellow-400/20" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-cyan-500/20"><h2 className="font-extrabold text-xl text-yellow-400 flex items-center gap-2"><BrainCircuit size={20} /> DIRECTOR'S VISION MATRIX</h2></div>
                <div className="p-4 overflow-y-auto space-y-4 text-sm">
                  <VisionDetail title="Core Theme">{directorsVision.core_theme}</VisionDetail>
                  <VisionDetail title="Visual Tone">{directorsVision.visual_tone}</VisionDetail>
                  <VisionDetail title="Cinematography">{directorsVision.cinematography_style}</VisionDetail>
                  {characterSheet && <VisionDetail title={`Character Sheet (${directorsVision.main_character})`}>{characterSheet}</VisionDetail>}
                  <VisionDetail title="Refined Script Snippet (first 300 chars)">{String(directorsVision.refined_script).slice(0, 300)}...</VisionDetail>
                </div>
                <div className="p-4 mt-auto border-t border-cyan-500/20 flex justify-end gap-3 bg-slate-900/40">
                  <button onClick={() => { AudioEngine.play('click'); setShowVisionModal(false); }} className="premium-button px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 rounded-md">REVIEW VISION LATER</button>
                  <button onClick={generateScenesFromVision} disabled={busy} className="premium-button px-4 py-2 text-sm bg-cyan-600 hover:bg-cyan-500 rounded-md disabled:opacity-50 font-bold">PROCEED TO SEGMENTATION</button>
                </div>
              </div>
            </div>
          )}

          {editingScene && (
            <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-lg flex items-center justify-center p-4" onClick={() => setEditingScene(null)}>
              <div className="glass-pane rounded-xl w-full max-w-lg border-yellow-400/20" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b border-cyan-500/20"><h2 className="font-semibold text-lg text-yellow-400">FRAME EDIT: {editingScene.sceneHeader}</h2></div>
                <div className="p-4 space-y-4">
                  <img src={editingScene.image} alt="Editing preview" className="rounded-lg w-full object-contain max-h-64 border border-slate-700" />
                  <textarea value={editPrompt} onChange={e => setEditPrompt(e.target.value)} placeholder="Enter precise visual instructions (e.g., 'change the light source to be warmer and add heavy rain')" rows={3} className="w-full bg-slate-800 border-slate-700 rounded-md p-2 text-sm focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                </div>
                <div className="p-4 flex justify-end gap-3 bg-slate-900/40 border-t border-cyan-500/20">
                  <button onClick={() => { AudioEngine.play('click'); setEditingScene(null); setEditPrompt(''); }} className="premium-button px-4 py-2 text-sm bg-slate-700 rounded-md hover:bg-slate-600">CANCEL</button>
                  <button onClick={handleEditImage} disabled={isEditing || !editPrompt} className="premium-button px-4 py-2 text-sm bg-yellow-600 rounded-md hover:bg-yellow-500 disabled:opacity-50 text-black font-bold">
                    {isEditing ? <Loader2 size={16} className="animate-spin text-black" /> : 'APPLY EDIT ($0.10)'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {magicToolOutput && (
            <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-lg flex items-center justify-center p-4" onClick={() => setMagicToolOutput(null)}>
              <div className="glass-pane rounded-xl w-full max-w-2xl max-h-[80vh] flex flex-col border-cyan-400/20" onClick={e => e.stopPropagation()}>
                <div className="p-4 flex justify-between items-center border-b border-cyan-500/20">
                  <h2 className="font-extrabold text-xl text-cyan-400 capitalize flex items-center gap-2"><Sparkles size={20} /> CREATIVE SYNTHESIS: {magicToolOutput.title}</h2>
                  <button onClick={() => { AudioEngine.play('click'); setMagicToolOutput(null); }} className="p-1 rounded-full hover:bg-slate-700"><X size={20} /></button>
                </div>
                <div className="p-4 overflow-y-auto">
                  {magicToolOutput.loading ? (
                    <div className="flex items-center justify-center min-h-[100px]"><Loader2 size={32} className="animate-spin text-cyan-400" /></div>
                  ) : Array.isArray(magicToolOutput.data) ? (
                    <ol className="list-decimal list-inside text-sm space-y-3 p-4 bg-slate-900/70 rounded-md border border-slate-700">
                      {magicToolOutput.data.map((item, index) => (
                        <li key={index} className="pl-2">
                          {typeof item === 'object' && item.moment && item.shot ? (
                            <div className="space-y-1">
                              <p className="font-bold text-cyan-300">Moment: <span className="font-normal text-slate-300">{item.moment}</span></p>
                              <p className="font-bold text-blue-300">Shot Type: <span className="font-normal text-slate-300">{item.shot}</span></p>
                              <p className="font-bold text-purple-300">Emotional Target: <span className="font-normal text-slate-300">{item.emotion}</span></p>
                            </div>
                          ) : (
                            <p className="text-slate-300">{item}</p>
                          )}
                        </li>
                      ))}
                    </ol>
                  ) : typeof magicToolOutput.data === 'string' ? (
                    <pre className="text-sm whitespace-pre-wrap bg-slate-900/70 p-4 rounded-md border-slate-700 border overflow-x-auto text-slate-300">{magicToolOutput.data}</pre>
                  ) : (
                    <div className="space-y-3 p-4 bg-slate-900/70 rounded-md border border-slate-700 text-xs">
                      {Object.entries(magicToolOutput.data).map(([key, value]) => (
                        <div key={key}>
                          <h3 className="font-bold text-cyan-300 capitalize">{key.replace(/_/g, ' ')}:</h3>
                          <p className="ml-4 text-slate-300">{Array.isArray(value) ? value.join(', ') : value}</p>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {showSettings && (
            <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-lg flex items-center justify-center p-4" onClick={() => setShowSettings(false)}>
              <div className="glass-pane rounded-xl w-full max-w-lg border-cyan-400/20" onClick={e => e.stopPropagation()}>
                <div className="p-4 flex justify-between items-center border-b border-cyan-500/20">
                  <h2 className="font-extrabold text-xl text-cyan-400 flex items-center gap-2"><Settings size={20}/> SYSTEM CONSOLE</h2>
                  <button onClick={() => { AudioEngine.play('click'); setShowSettings(false); }} className="p-1 rounded-full hover:bg-slate-700"><X size={20} /></button>
                </div>
                <div className="p-4 space-y-4">
                  <VisionDetail title="API Key Reference (Security Protocol: Handled by Runtime)">
                    <input type="text" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Key is managed by execution environment" className="w-full bg-slate-800 border-slate-700 rounded-md p-2 text-sm focus:ring-cyan-500 focus:border-cyan-500" />
                    <p className="text-xs text-slate-500 mt-2">This field is for external deployment configuration only. All runtime API calls are secured and managed automatically.</p>
                  </VisionDetail>
                  <VisionDetail title="Current AI Models">
                    <p className="font-mono text-xs">Text/Vision: {textModel}</p>
                    <p className="font-mono text-xs">Image/Edit: gemini-2.5-flash-image-preview</p>
                  </VisionDetail>
                </div>
                <div className="p-4 mt-auto border-t border-cyan-500/20 bg-slate-900/40">
                  <button onClick={() => {AudioEngine.play('click'); setShowSettings(false);}} className="premium-button w-full px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 rounded-md font-bold">CLOSE CONSOLE</button>
                </div>
              </div>
            </div>
          )}

          {showHistoryModal && (
            <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-lg flex items-center justify-center p-4" onClick={() => setShowHistoryModal(false)}>
              <div className="glass-pane rounded-xl w-full max-w-3xl max-h-[90vh] flex flex-col border-cyan-400/20" onClick={e => e.stopPropagation()}>
                <div className="p-4 flex justify-between items-center border-b border-cyan-500/20">
                  <h2 className="font-extrabold text-xl text-cyan-400 flex items-center gap-2"><Clock size={20}/> PROJECT HISTORY LOG</h2>
                  <button onClick={() => { AudioEngine.play('click'); setShowHistoryModal(false); }} className="p-1 rounded-full hover:bg-slate-700"><X size={20} /></button>
                </div>
                <div className="p-4 overflow-y-auto space-y-4">
                  {historyItems.length === 0 ? (
                    <p className="text-slate-400 text-center py-8">History Log Empty. Generate a project to save state.</p>
                  ) : (
                    <div className="divide-y divide-slate-800">
                      {historyItems.map((item, index) => (
                        <div key={item.timestamp} className="py-3 px-3 hover:bg-slate-900/50 rounded-lg transition duration-150 group flex justify-between items-start">
                          <div className='flex-1 pr-4'>
                            <div className='flex justify-between items-center'>
                              <h3 className="text-sm font-bold text-cyan-300">
                                {item.config.scriptFile || `Project: ${item.scenes[0]?.sceneHeader || `Storyboard ${index + 1}`}`}
                              </h3>
                              <p className="text-xs text-slate-500">{new Date(item.timestamp).toLocaleDateString()}</p>
                            </div>
                            <p className="text-xs text-slate-400 mt-1">
                              <span className="font-semibold">Theme:</span> {item.vision?.core_theme || 'N/A'} | <span className="font-semibold">Frames:</span> {item.scenes.length} | <span className="font-semibold">Cost:</span> ${item.cost.toFixed(2)}
                            </p>
                            <div className="mt-2 flex space-x-2 overflow-x-auto pb-1">
                              {item.scenes.slice(0, 5).map((s, i) => (
                                <img key={i} src={s.image || `https://placehold.co/60x34/0f172a/707070?text=${s.status.slice(0,1)}`} alt={`Scene ${i}`} className="w-16 h-9 object-cover rounded border border-slate-700 group-hover:border-cyan-400/50" />
                              ))}
                              {item.scenes.length > 5 && <span className="text-xs text-slate-500 self-center pl-2">+{item.scenes.length - 5}</span>}
                            </div>
                          </div>
                          <button onClick={() => { AudioEngine.play('click'); loadHistoryItem(item); }} className="premium-button flex-shrink-0 text-xs px-3 py-1.5 rounded-md bg-cyan-700/50 hover:bg-cyan-600/70 border border-cyan-500/50 self-center font-bold">
                            <span className='flex items-center gap-1'><RotateCw size={12}/> RELOAD</span>
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                <div className="p-4 mt-auto border-t border-cyan-500/20 bg-slate-900/40">
                  <button onClick={() => {AudioEngine.play('click'); setShowHistoryModal(false);}} className="premium-button w-full px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 rounded-md font-bold">DONE</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    const VisionDetail = ({ title, children }) => (
      <div className="space-y-1">
        <h3 className="font-bold text-slate-300">{title}:</h3>
        <div className="text-xs p-2 bg-slate-800/50 rounded-md whitespace-pre-wrap border border-slate-700">{children}</div>
      </div>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
